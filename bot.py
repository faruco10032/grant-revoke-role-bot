# -*- coding: utf-8 -*-
"""
Pythonâ€¯3.8 ã§ã‚‚å‹•ãã‚ˆã†ã«
  â€¢ PEPâ€¯604 ã® `|` ã‚’ Optional[...] ã«ç½®ãæ›ãˆ
  â€¢ typing.Optional ã‚’ã‚¤ãƒ³ãƒãƒ¼ãƒˆ
ãã®ã»ã‹ã®ãƒ­ã‚¸ãƒƒã‚¯ã¯å¤‰æ›´ãªã—
"""
import os
import asyncio
from typing import Optional        # â˜… è¿½åŠ 

import discord
from discord.ext import commands
from discord import app_commands

# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
# ç’°å¢ƒå¤‰æ•°èª­ã¿è¾¼ã¿
# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
if os.getenv("RENDER") is None:    # NAS ãªã©ãƒ­ãƒ¼ã‚«ãƒ«å®Ÿè¡Œæ™‚
    from dotenv import load_dotenv
    load_dotenv()

TOKEN = os.getenv("DISCORD_TOKEN")
if not TOKEN:
    raise RuntimeError("DISCORD_TOKEN is not set in environment variables.")

# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
# Bot Intents
# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
intents = discord.Intents.default()
intents.message_content = True
intents.members = True

# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
# ãƒœã‚¿ãƒ³ç”¨ View
# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
class RoleButtonView(discord.ui.View):
    def __init__(
        self,
        role: discord.Role,
        duration: int,
        notify_channel: Optional[discord.TextChannel] = None   # â˜… Optional ã«å¤‰æ›´
    ) -> None:
        super().__init__(timeout=None)
        self.role = role
        self.duration = duration
        self.notify_channel = notify_channel

    @discord.ui.button(label="ãƒ­ãƒ¼ãƒ«ã‚’å—ã‘å–ã‚‹", style=discord.ButtonStyle.primary)
    async def grant_role(                      # noqa: D401
        self,
        interaction: discord.Interaction,
        button: discord.ui.Button
    ):
        member = interaction.user
        role = self.role

        if role in member.roles:
            await interaction.response.send_message(
                "ã™ã§ã«ãƒ­ãƒ¼ãƒ«ã‚’æŒã£ã¦ã„ã¾ã™ã€‚",
                ephemeral=True
            )
            return

        await member.add_roles(role)
        await interaction.response.send_message(
            f"{role.name} ã‚’ä»˜ä¸ã—ã¾ã—ãŸï¼\n{self.duration}åˆ†å¾Œã«è‡ªå‹•ã§å¤–ã‚Œã¾ã™ã€‚",
            ephemeral=True
        )

        # æŒ‡å®šåˆ†ã ã‘å¾…ã£ã¦ã‹ã‚‰ãƒ­ãƒ¼ãƒ«ã‚’å‰¥å¥ª
        await asyncio.sleep(self.duration * 60)
        await member.remove_roles(role)

        # é€šçŸ¥ãƒãƒ£ãƒ³ãƒãƒ«ãŒã‚ã‚Œã°é€ä¿¡ï¼ˆå¤±æ•—ã¯æ¡ã‚Šã¤ã¶ã™ï¼‰
        if self.notify_channel:
            try:
                await self.notify_channel.send(
                    f"{member.mention} ã® {role.name} ãƒ­ãƒ¼ãƒ«ã‚’è‡ªå‹•ã§å‰¥å¥ªã—ã¾ã—ãŸã€‚"
                )
            except Exception:
                pass

# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
# Bot æœ¬ä½“
# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
class MyBot(commands.Bot):
    def __init__(self) -> None:
        super().__init__(
            command_prefix="!",
            intents=intents,
            help_command=None
        )

    async def setup_hook(self) -> None:
        await self.tree.sync()
        print("ã‚¹ãƒ©ãƒƒã‚·ãƒ¥ã‚³ãƒãƒ³ãƒ‰ã‚’åŒæœŸã—ã¾ã—ãŸ")

bot = MyBot()

@bot.event
async def on_ready() -> None:
    print(f"Bot is online: {bot.user}")

# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
# /setup_button ã‚³ãƒãƒ³ãƒ‰
# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
@bot.tree.command(name="setup_button", description="ãƒ­ãƒ¼ãƒ«ä»˜ä¸ãƒœã‚¿ãƒ³ã‚’ä½œæˆã—ã¾ã™")
@app_commands.describe(
    role="ä»˜ä¸ã—ãŸã„ãƒ­ãƒ¼ãƒ«",
    minutes="ãƒ­ãƒ¼ãƒ«ã‚’ä¿æŒã™ã‚‹æ™‚é–“ï¼ˆåˆ†ï¼‰",
    notify_channel="ãƒ­ãƒ¼ãƒ«å‰¥å¥ªæ™‚ã«é€šçŸ¥ã™ã‚‹ãƒãƒ£ãƒ³ãƒãƒ«"
)
async def setup_button(
    interaction: discord.Interaction,
    role: discord.Role,
    minutes: int = 10,
    notify_channel: Optional[discord.TextChannel] = None       # â˜… Optional ã«å¤‰æ›´
):
    if minutes <= 0:
        await interaction.response.send_message(
            "æ™‚é–“ã¯1åˆ†ä»¥ä¸Šã«ã—ã¦ãã ã•ã„ã€‚",
            ephemeral=True
        )
        return

    view = RoleButtonView(role, duration=minutes, notify_channel=notify_channel)

    # è‡ªåˆ†ã«ã ã‘ã€Œé€ä¿¡ã—ãŸã‚ˆã€ã¨è¿”ã™
    await interaction.response.send_message(
        f"{role.name} ã‚’å–å¾—ã§ãã‚‹ãƒœã‚¿ãƒ³ã‚’é€ä¿¡ã—ã¾ã™ã€‚",
        ephemeral=True
    )
    # å…¬é–‹ãƒãƒ£ãƒ³ãƒãƒ«ã«ãƒœã‚¿ãƒ³ä»˜ããƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’æŠ•ç¨¿
    await interaction.channel.send(
        f"{role.name} ã‚’å–å¾—ã—ãŸã„äººã¯ä»¥ä¸‹ã‚’æŠ¼ã—ã¦ãã ã•ã„ï¼š",
        view=view
    )

# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
# /help ã‚³ãƒãƒ³ãƒ‰
# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
@bot.tree.command(name="help", description="ã“ã®Botã®ä½¿ã„æ–¹ã‚’è¡¨ç¤ºã—ã¾ã™")
async def help_command(interaction: discord.Interaction):
    help_text = (
        "**ğŸ“˜ Botã®ä½¿ã„æ–¹**\n\n"
        "`/setup_button ãƒ­ãƒ¼ãƒ« æ™‚é–“(åˆ†) é€šçŸ¥ãƒãƒ£ãƒ³ãƒãƒ«` ã‚’å®Ÿè¡Œã™ã‚‹ã¨ã€ãƒ­ãƒ¼ãƒ«å–å¾—ç”¨ã®ãƒœã‚¿ãƒ³ä»˜ããƒ¡ãƒƒã‚»ãƒ¼ã‚¸ãŒæŠ•ç¨¿ã•ã‚Œã¾ã™ã€‚\n"
        "ãƒœã‚¿ãƒ³ã‚’æŠ¼ã—ãŸãƒ¦ãƒ¼ã‚¶ãƒ¼ã«ã¯ãã®ãƒ­ãƒ¼ãƒ«ãŒä¸€æ™‚çš„ã«ä»˜ä¸ã•ã‚Œã€æŒ‡å®šæ™‚é–“å¾Œã«è‡ªå‹•ã§å‰Šé™¤ã•ã‚Œã¾ã™ã€‚\n\n"
        "**ğŸ”” é€šçŸ¥ãƒãƒ£ãƒ³ãƒãƒ«ã«ã¤ã„ã¦ï¼š**\n"
        "- é€šçŸ¥ãƒãƒ£ãƒ³ãƒãƒ«ã‚’æŒ‡å®šã™ã‚‹ã¨ã€ãƒ­ãƒ¼ãƒ«ã®å‰¥å¥ªæ™‚ã«ãã®ãƒãƒ£ãƒ³ãƒãƒ«ã¸ãƒ¡ãƒ³ã‚·ãƒ§ãƒ³ä»˜ãã§é€šçŸ¥ã•ã‚Œã¾ã™ã€‚\n"
        "- é€šçŸ¥ãƒãƒ£ãƒ³ãƒãƒ«ã¯ã€å¿…è¦ã«å¿œã˜ã¦é€šçŸ¥è¨­å®šã‚’ã€Œãƒ¡ãƒ³ã‚·ãƒ§ãƒ³æ™‚ã®ã¿ã€ã«ã—ã¦ãã ã•ã„ï¼ˆBotã¯DMã‚’é€ã‚Šã¾ã›ã‚“ï¼‰ã€‚\n"
        "- é€šçŸ¥ãƒãƒ£ãƒ³ãƒãƒ«ã®æŒ‡å®šã¯ä»»æ„ã§ã™ï¼ˆçœç•¥å¯ï¼‰ã€‚\n\n"
        "**ğŸ“ ä½¿ç”¨ä¾‹ï¼š**\n"
        "`/setup_button @ä¸€æ™‚å…¥å®¤ 10 #ãƒ­ãƒ¼ãƒ«é€šçŸ¥`\n"
        "â†’ ã€Œä¸€æ™‚å…¥å®¤ã€ãƒ­ãƒ¼ãƒ«ã‚’10åˆ†é–“ä»˜ä¸ã—ã€10åˆ†å¾Œã« #ãƒ­ãƒ¼ãƒ«é€šçŸ¥ ã«ãƒ¡ãƒ³ã‚·ãƒ§ãƒ³ä»˜ãã§å‰¥å¥ªé€šçŸ¥ã‚’æŠ•ç¨¿ã—ã¾ã™ã€‚\n\n"
        "**âš ï¸ æ³¨æ„ï¼š**\n"
        "- Botã®ãƒ­ãƒ¼ãƒ«ã¯ã€ä»˜ä¸ãƒ»å‰¥å¥ªå¯¾è±¡ã®ãƒ­ãƒ¼ãƒ«ã‚ˆã‚Šä¸Šä½ã«ã‚ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™ã€‚\n"
        "- ãƒ­ãƒ¼ãƒ«ã‚„ãƒãƒ£ãƒ³ãƒãƒ«ã¯é¸æŠå¼ï¼ˆã‚ªãƒ¼ãƒˆã‚³ãƒ³ãƒ—ãƒªãƒ¼ãƒˆï¼‰ã§æŒ‡å®šã§ãã¾ã™ã€‚\n"
    )
    await interaction.response.send_message(help_text, ephemeral=True)

# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
# èµ·å‹•
# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
bot.run(TOKEN)
